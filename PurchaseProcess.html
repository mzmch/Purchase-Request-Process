<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Purchase Requests Viewer</title>
    <style>
        body {
    font-family: Arial, sans-serif;
    background: linear-gradient(to bottom right, #2e7d32, #6c757d); /* Gradient from dark green to grey */
     padding: 0;
    margin: 0;
    display: flex; /* Flexbox to place sidebar on the left */
    height: 100vh;
}

        .sidebar {
            width: 120px;
            background-color: #2e7d32;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
            position: relative; /* Keeps it fixed to the left */
        }

        .menu-section {
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .submenu {
            list-style: none;
            padding-left: 20px;
            display: none;
        }

        .submenu.show {
            display: block;
        }

        .submenu li {
            padding: 5px 0;
            cursor: pointer;
        }

        .submenu li.active, .menu-section.active {
            background-color: #1b5e20;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* Make sure content area is scrollable if needed */
        }

        h1 {
            color: white;
        }


table {
    width: 100%; /* Ensures the table takes up full available width */
    max-width: 100%; /* Ensures the table doesn't overflow the page */
    border-collapse: collapse;
    margin-top: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    background-color: white;
    cursor: pointer;
}

th, td {
    padding: 6px;
    border: 1px solid #ccc;
    text-align: left;
    word-wrap: break-word;
    max-width: 100px;
    overflow: hidden;
}

th {
    background-color: #2e7d32;
    color: white;
}

tr:nth-child(odd) {
    background-color: #f0fff0;
}

tr:nth-child(even) {
    background-color: #f9f9f9;
}

tr.selected {
    background-color: #c8e6c9 !important;
}


        

        input[type="text"] {
            padding: 8px;
            width: 200px;
            margin-right: 10px;
        }

        button {
            padding: 6px 12px;
            margin: 5px;
            cursor: pointer;
            background-color: #2e7d32;
            color: white;
            border: 2px solid white; /* White border */
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Shadow */
    transition: box-shadow 0.3s ease; /* Smooth transition for shadow */
        }

        button:hover {
    background-color: #388e3c; /* Darker green background on hover */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Darker shadow on hover */
}

button:focus {
    outline: none; /* Remove the default outline when focused */
}

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            max-width: 600px;
            width: 90%;
            overflow-y: auto;
            max-height: 80vh;
        }

        #loading {
            display: none;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 1000;
        }
        .error-message{
            color:red;
        }

        .pagination {
            margin-top: 10px;
        }
        .pagination button {
            margin-right: 5px;
        }

       
        /* Styles for the details table in the modal */
        #details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
        }

        #details-table th, #details-table td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: left;
        }

        #details-table th {
            background-color: #2e7d32;
            color: white;
        }

        .details-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .details-actions button {
            margin-left: 10px;
        }

        /* Hover effect for table rows */
        #data-table tbody tr:hover {
            background-color: #d4edda; /* Light green hover background */
            cursor: pointer;          /* Change cursor to pointer on hover */
        }

        #email-display {
            position: absolute;
            top: 10px;
            right: 100px;
            color: white;
            font-size: 16px;
            z-index: 1000;
        }

        #logoutButton {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            background-color: #d32f2f; /* Red color for logout */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        #logoutButton:hover {
            background-color: #c62828; /* Darker red when hovered */
        }

    </style>
</head>
<body>
    <div class="sidebar">
        <div class="menu-section" onclick="toggleMenu()">
            Requests <span id="arrow">&#9654;</span>
        </div>
        <ul class="submenu" id="submenu">
            <li onclick="filterByStatus('waiting', this)">Waiting</li>
            <li onclick="filterByStatus('approved', this)">Approved</li>
            <li onclick="filterByStatus('rejected', this)">Rejected</li>
            <li onclick="filterByStatus('all', this)">All</li>
        </ul>
    </div>
    <div class="content">
        <div id="loading">Loading...</div>
        <h1>Purchase Requests</h1>
        <input type="text" id="searchDept" placeholder="Search by Department">
        <input type="text" id="searchMobile" placeholder="Search by Mobile">
        <button onclick="fetchData()">Search</button>
        <button onclick="exportToExcel()">Export to Excel</button>
        <table id="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Mobile</th>
                    <th>Email</th>
                    <th>Item</th>
                    <th>Specification</th>
                    <th>Estimated Cost</th>
                    <th>Total Cost</th>
                    <th>Justification</th>
                    <th>Vendor</th>
                    <th>Contact</th>
                    <th>Reason</th>
                    <th id="actionHeader">Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
        <div id="error-message" class = "error-message"></div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <h3>Request Details</h3>
            <table id="details-table">
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div class="details-actions" id="detailsActions">
                <button id="detailsApprove" onclick="handleApprove()">Approve</button>
                <button id="detailsReject" onclick="handleReject()">Reject</button>
                <button onclick="printDetails()">Print</button>
                <button onclick="closeDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>Add Note</h3>
            <textarea id="note" rows="4" style="width:100%;"></textarea><br>
            <button id="submitNote">Submit</button>
            <button onclick="closeModal()">Cancel</button>
        </div>
    </div>
    <div id="email-display"></div>
    <button id="logoutButton" onclick="logout()">Logout</button>


    <script>
        const SHEET_URL = "https://script.google.com/macros/s/AKfycbz5OgHLArUF1OU7JisIM-X8gejBOVCgiPCExPkL8ZcJ0sbcDZamrqOnAsMHlbrdP6Lj/exec";
        let allData = [];
        let currentPage = 1;
        let currentStatus = 'waiting';
        const pageSize = 10;
        let currentAction = '';
        let currentRow = 0;
        let menuOpen = false;
        let headers = [];
        let selectedRowData = null;

        function toggleMenu() {
            const submenu = document.getElementById("submenu");
            const arrow = document.getElementById("arrow");
            menuOpen = !menuOpen;
            submenu.classList.toggle("show", menuOpen);
            arrow.innerHTML = menuOpen ? "&#9660;" : "&#9654;";
        }

        function formatDate(inputDate) {
            const date = new Date(inputDate);
            if (isNaN(date)) return inputDate;
            const options = { day: '2-digit', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
            return date.toLocaleString('en-US', options);
        }

        function fetchData() {
            const dept = document.getElementById("searchDept").value.trim();
            const mobile = document.getElementById("searchMobile").value.trim();
            document.getElementById("loading").style.display = "flex";
            document.getElementById("error-message").textContent = ""; // Clear previous error message


            const url = `${SHEET_URL}?department=${encodeURIComponent(dept)}&mobile=${encodeURIComponent(mobile)}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json(); // Parse the JSON body
                })
                .then(data => {
                    console.log("Fetched Data:", data);
                    if (data && data.error) {  // Check for error object
                        document.getElementById("error-message").textContent = "Error from server: " + data.error;
                        document.getElementById("loading").style.display = "none";
                        return;
                    }
                    allData = data.slice(1);
                    headers = data[0];
                    if (currentStatus !== 'all') {
                        allData = allData.filter(row => row[14]?.toLowerCase() === currentStatus);
                    }
                    currentPage = 1;
                    renderTable();
                    document.getElementById("loading").style.display = "none";
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    document.getElementById("error-message").textContent = "Error: " + error.message;
                    document.getElementById("loading").style.display = "none";
                });
        }

        function filterByStatus(status, el) {
            currentStatus = status;
            document.querySelectorAll('.submenu li').forEach(li => li.classList.remove('active'));
            el.classList.add('active');
            fetchData();
        }

        function renderTable() {
            const tbody = document.querySelector("#data-table tbody");
            tbody.innerHTML = "";
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = allData.slice(start, end);

            pageData.forEach((row, index) => {
                const tr = document.createElement("tr");
                tr.dataset.row = JSON.stringify(row);
                tr.addEventListener('click', () => showRowDetails(row));
                row.slice(0, 13).forEach((cell, idx) => {
                    const td = document.createElement("td");
                    let cellContent = String(cell);
                    if (cellContent.length > 100) {
                        cellContent = cellContent.substring(0, 100) + "...";
                    }
                    td.textContent = idx === 0 ? formatDate(cell) : cellContent;
                    tr.appendChild(td);
                });

                const td = document.createElement("td");
                if (currentStatus === 'waiting') {
                    td.innerHTML = `
                        <button onclick="openModal('approve', ${start + index + 1})">Approve</button>
                        <button onclick="openModal('reject', ${start + index + 1})">Reject</button>
                    `;
                } else if (currentStatus === 'all') {
                    let actionContent = row[14] || '';
                    if (actionContent.length > 100) {
                         actionContent = actionContent.substring(0, 100) + "...";
                    }
                    td.textContent = actionContent;
                } else {
                    td.textContent = '';
                }
                tr.appendChild(td);
                tbody.appendChild(tr);
            });
            renderPagination();
        }

        function renderPagination() {
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";
            const totalPages = Math.ceil(allData.length / pageSize);
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.onclick = () => { currentPage = i; renderTable(); };
                if (i === currentPage) btn.disabled = true;
                pagination.appendChild(btn);
            }
        }

        function exportToExcel() {
            const table = document.getElementById("data-table");
            if (!table) {
                alert('Table element not found.');
                return;
            }
            let tableHTML = table.outerHTML.replace(/ /g, '%20');
            const filename = 'purchase_requests.xls';
            const dataType = 'application/vnd.ms-excel';

            const a = document.createElement('a');
            document.body.appendChild(a);
            a.href = 'data:' + dataType + ', ' + tableHTML;
            a.download = filename;
            a.click();
            document.body.removeChild(a);
        }

        function openModal(action, rowIdx) {
            currentAction = action;
            currentRow = rowIdx;
            document.getElementById("modal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
            document.getElementById("note").value = "";
        }

        document.getElementById("submitNote").addEventListener("click", function submitNote() {
            const note = document.getElementById("note").value.trim();
            if (!note) return alert("Please enter a note.");
            const email = "user@example.com";
            const now = new Date().toLocaleString('en-US', { hour12: true });

            fetch(SHEET_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: currentAction,
                    row: currentRow,
                    email: email,
                    timestamp: now,
                    note: note
                })
            })
            .then(response => {
                  if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                  }
                  return response.json();
            })
            .then(data => {
                alert(data.result === "success" ? "Submitted!" : "Error occurred.");
                closeModal();
                fetchData();
            })
            .catch(err => alert("Error: " + err.message));
        });

        function showRowDetails(rowData) {
            selectedRowData = rowData;
            const detailsTableBody = document.querySelector("#details-table tbody");
            detailsTableBody.innerHTML = "";

            let i = 0;
            for (const [key, value] of Object.entries(rowData)) {
                const tr = document.createElement("tr");
                const keyTd = document.createElement("td");
                const valueTd = document.createElement("td");
                const displayValue = String(value);

                keyTd.textContent = headers[i];
                valueTd.textContent = displayValue;

                tr.appendChild(keyTd);
                tr.appendChild(valueTd);
                detailsTableBody.appendChild(tr);
                i++;
            }

            const detailsActions = document.getElementById("detailsActions");
            detailsActions.innerHTML = '';

            if (rowData[14]?.toLowerCase() === 'waiting') {
                const approveButton = document.createElement("button");
                approveButton.textContent = "Approve";
                approveButton.id = "detailsApprove";
                approveButton.onclick = handleApprove;
                detailsActions.appendChild(approveButton);

                const rejectButton = document.createElement("button");
                rejectButton.textContent = "Reject";
                approveButton.id = "detailsReject";
                rejectButton.onclick = handleReject;
                detailsActions.appendChild(rejectButton);
            }

            const printButton = document.createElement("button");
            printButton.textContent = "Print";
            printButton.onclick = printDetails;
            detailsActions.appendChild(printButton);

            const closeButton = document.createElement("button");
            closeButton.textContent = "Close";
            closeButton.onclick = closeDetailsModal;
            detailsActions.appendChild(closeButton);

            document.getElementById("detailsModal").style.display = "flex";
        }

        function closeDetailsModal() {
            document.getElementById("detailsModal").style.display = "none";
        }

        function handleApprove() {
            if (!selectedRowData) return;
            openModal('approve', allData.indexOf(selectedRowData) + 1);
        }

        function handleReject() {
            if (!selectedRowData) return;
            openModal('reject', allData.indexOf(selectedRowData) + 1);
        }



        function logout() {
    // Clear user data from localStorage
    localStorage.removeItem("user");
    
    // Redirect to index.html
    window.location.href = "index.html";
}

        
function printDetails() {
    const rowData = selectedRowData;
    if (!rowData || !headers.length) return;

    let html = `
        <html>
        <head>
            <title>Print Details</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                }
                h2 {
                    color: #2e7d32;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                }
                th, td {
                    padding: 10px;
                    border: 1px solid #ccc;
                    text-align: left;
                }
                th {
                    background-color: #2e7d32;
                    color: white;
                }
            </style>
        </head>
        <body>
            <h2>Purchase Request Details</h2>
            <table>
                <thead>
                    <tr><th>Field</th><th>Value</th></tr>
                </thead>
                <tbody>`;

    rowData.forEach((value, index) => {
        html += `<tr>
                    <td>${headers[index] || "Field " + (index + 1)}</td>
                    <td>${value}</td>
                 </tr>`;
    });

    html += `
                </tbody>
            </table>
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}



function displayUserEmail() {
    const userData = localStorage.getItem("user");
    if (userData) {
        const parsedUser = JSON.parse(userData);
        const email = parsedUser.email;
        document.getElementById("email-display").textContent = "Logged in: " + email;
    } else {
        document.getElementById("email-display").textContent = "Not logged in.";
    }
}
        



        window.addEventListener("DOMContentLoaded", function() {
            fetchData();
            displayUserEmail(); // Call the function to display the email
        });
    </script>
</body>
</html>
